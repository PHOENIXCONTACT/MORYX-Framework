# ResourceRpcEndpoint

 Endpoint to remote call a procedure/method on a resource. It uses topic templates and route constraint just like `ASP.net routes` .
Find the list of available constraints [Here](https://learn.microsoft.com/en-us/aspnet/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2#route-constraints).

1. **Why do we need a ResourceRpcEndpoint ?**

    - Scenario :

        Here is a scenario where i need the `ResourceRpcEndpoint`. We have 2 MORYX instances running on different machine. One is a Raspberry pi and one is a desktop, both on the same WiFi network. The Raspberry pi only has one MORYX resource called `Camera` with a physical camera connected. And the desktop has all the station of the `Machine` (Note: the physical machine is an entire factory floor). At one particular station `Printing` we need to take pictures. For that the `Printing` station needs to send a `Take a picture and send it to me` command to the `Camera` (Which is on the Raspberry pi).

2. **Setup**

    A configuration file will be autogenerated inside the default MORYX Config folder. The content is as follow:

    ```json
    {
    "Id": "my-id",
    "Host": "localhost",
    "Port": 1883,
    "Username": null,
    "Password": null,
    "Tls": false,
    "QoS": 1, // check the MqttQualityOfServiceLevel enum for more info
    "ReconnectDelayMs": 30000,
    "ReconnectWithClientSession": true,
    "RootTopic": "" // optional
    }
    ```

    ```csharp
    // Program.cs
    builder.Services.AddMqttClient((provider, options) =>
    {
        var configManager = provider.GetRequiredService<IConfigManager>();
        //Setup Mqtt client connection
        var config = configManager.GetConfiguration<MqttConnectionConfig>();
        // If configuration is generated, save it back to persist defaults
        if (config.ConfigState == ConfigState.Generated)
        {
            config.ConfigState = ConfigState.Valid;
            configManager.SaveConfiguration(config);
        }
        // Mqtt Client configuration
        options.Connection = config;}
        ).AddMqttEndpoints(); // <-- this add supports for the endpoints
    ```

3. **Response Payload (Schema)**:

    ```json
        {
        "Value" : object,
        "ValueType" : number // check EntryValueType for more infos
        }
    ```

4. **Request Payload (Schema)**:

    ```json
        {
        [Key] : [Value] // if your method expect parameters, these should match the name of those parameters
        }
    ```

    - Example:

        ```json
        {
        "Path": "c://users/documents/my-documents/private/image.jpeg",
        "Action": "Save"
        }
        ```

    the method to invoke will look like this :

    ```csharp
    //code
    public void Method(string action, string path)
    {
        //code
    }
    //code
    ```

5. **Example**:

    Given the following Resource:

        ```csharp
        public interface IMyPublicMethods
        {
            void MethodWithParams(int value){
                //code
            }

            int MethodWithResult()
            {
                return 1;
            }
        }

        [ResourceAvailableAs(typeof(IMyPublicMethod)))]
        public class ExampleResource : Resource, IMyPublicMethods
        {
            public long Id => 1; // example
            public void MethodWithParams(int value)
            {
                //code
            }

            public int MethodWithResult()
            {
                return 1
            }
            // codes...
        }
        ```

    - When a client sends a message to the following topic : `moryx/device-2/resources/1/invoke/MethodWithParams` with this payload

        ```json
        {
        "Value": 152
        }
        ```

    - The `ResourceRpcEndpoint` will be triggered and the method `MethodWithParams` will be invoked. The payload inside the message is used as value for the method parameters , in this case `Value = 123` the name matches the parameter name (not case sensitive). The response message has the following schema:

        ```json
            {
            "Value" = {}, // any object/type
            "ValueType" = number // check EntryValueType for more infos
            }
        ```

    - When a client sends a message to the following topic : `resources/1/invoke/MethodWithResult` with an empty payload
    and a response topic `device-125/resources/1/MethodWithResult/response`

    - The `ResourceRpcEndpoint` will be triggered and the method `MethodWithResult` will be invoked. And the return value `1` will be sent back to the broker using the topic `device-125/resources/1/MethodWithResult/response`.

    **Note** : All serialization a done via `MqttMessageSerialization`
