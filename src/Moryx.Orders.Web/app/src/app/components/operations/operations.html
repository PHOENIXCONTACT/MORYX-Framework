@if (!isLoading()) {
  @if (operations().length) {
    <mat-drawer-container
      class="operations-drawer-container"
      [hasBackdrop]="mobileQuery.matches"
      >
      <mat-drawer
        #drawer
        [mode]="mobileQuery.matches ? 'over' : 'side'"
        position="end"
        class="operations-drawer"
        >
        @switch (drawerContent()) {
          @case (DrawerContent.Messages) {
            <div class="operations-drawer-content">
              <div class="operations-drawer-title">
                <h2>{{ TranslationConstants.OPERATIONS.TITLE | translate }}</h2>
                <a mat-icon-button (click)="closeDrawer()">
                  <mat-icon>close</mat-icon>
                </a>
              </div>
              <app-log-message-list
                [guid]="selectedOperation()?.identifier!"
              ></app-log-message-list>
            </div>
          }
          @case (DrawerContent.Parts) {
            <div class="operations-drawer-content">
              <div class="operations-drawer-title">
                <h2>{{ TranslationConstants.OPERATIONS.SUB_TITLE | translate }}</h2>
                <a mat-icon-button (click)="drawer.close()">
                  <mat-icon>close</mat-icon>
                </a>
              </div>
              <app-part-list
                [guid]="selectedOperation()?.identifier!"
              ></app-part-list>
            </div>
          }
          @case (DrawerContent.Source) {
            <div class="operations-drawer-content">
              <div class="operations-drawer-title">
                <h2>
                  {{ TranslationConstants.OPERATIONS.SOURCE_TITLE | translate }}
                </h2>
                <a mat-icon-button (click)="drawer.close()">
                  <mat-icon>close</mat-icon>
                </a>
              </div>
              <app-operation-source
                [operationSource]="selectedOperation()?.operationSource!"
              ></app-operation-source>
            </div>
          }
        }
      </mat-drawer>
      <mat-drawer-content>
        <div class="operation-list">
          <mat-accordion>
            @for (operation of filteringOperations(operations()); track operation) {
              <mat-expansion-panel
                class="operation"
                (expandedChange)="onPanelExpandedChange($event, operation)"
                >
                <mat-expansion-panel-header
                  [collapsedHeight]="'128px'"
                  [expandedHeight]="'128px'"
                  class="operation-header flex-row-center"
                  >
                  <div class="flex-row-center">
                    @if (!operation.model.canBegin) {
                      <mat-icon
                        class="operation-state-indicator operation-indicator-disabled"
                        >error
                      </mat-icon>
                    }
                    @if (
                      operation.model.canBegin &&
                      operation.model.classification !== 'Running' &&
                      operation.model.classification !== 'Interrupting'
                      ) {
                      <mat-icon
                        color="primary"
                        class="operation-state-indicator"
                        >settings</mat-icon
                        >
                      }
                      @if (
                        operation.model.classification === 'Running' &&
                        !operation.isProducing
                        ) {
                        <mat-icon
                          color="accent"
                          class="operation-state-indicator"
                          >settings</mat-icon
                          >
                        }
                        @if (
                          operation.model.classification === 'Running' &&
                          operation.isProducing
                          ) {
                          <mat-icon
                            color="accent"
                            class="operation-state-indicator operation-indicator-animation"
                            >settings
                          </mat-icon>
                        }
                        @if (operation.model.classification === 'Interrupting') {
                          <mat-icon
                            class="flex-row-center operation-state-indicator operation-indicator-interrupting operation-indicator-animation"
                            >
                            settings</mat-icon
                            >
                          }
                        </div>
                        <div class="operation-header-content">
                          <div class="operation-header-row">
                            <h2 class="operation-title">
                              {{ operation.model.order }} -
                              {{ operation.model.number }}
                            </h2>
                          </div>
                          <div class="operation-header-row">
                            <h3 class="operation-subtitle">
                              {{ TranslationConstants.OPERATIONS.PRODUCT | translate }}:
                              {{ operation.model.productIdentifier }}-{{
                              operation.model.productRevision | number : "2.0"
                              }}
                              {{ operation.model.productName }} |
                              {{
                              (operation.model.recipeIds?.length ?? 0) > 1
                              ? operation.model.recipeName + ", ..."
                              : operation.model.recipeName
                              }}
                            </h3>
                          </div>
                          <div class="operation-header-row">
                            <div>
                              {{ TranslationConstants.OPERATIONS.AMOUNT | translate }}:
                              {{ operation.model.totalAmount }}
                            </div>
                            <div class="flex-row-center operation-progress">
                              <div class="multi-progress-container">
                                <div
                                  class="bar success"
                                  [style.flex-basis.%]="operation.progressSuccessPercent"
                                  matTooltip="{{ TranslationConstants.OPERATIONS.SUCCESS | translate }}: {{ operation.progressSuccessPercent | number: '1.1-1' }}%">
                                </div>
                                <div
                                  class="bar scrap"
                                  [style.flex-basis.%]="operation.progressScrapPercent"
                                  matTooltip="{{ TranslationConstants.OPERATIONS.SCRAP | translate }}: {{ operation.progressScrapPercent | number: '1.1-1' }}%">
                                </div>
                                <div
                                  class="bar running"
                                  [style.flex-basis.%]="operation.progressRunningPercent"
                                  matTooltip="{{ TranslationConstants.OPERATIONS.RUNNING | translate }}: {{ operation.progressRunningPercent | number: '1.1-1' }}%">
                                </div>
                                <div
                                  class="bar pending"
                                  [style.flex-basis.%]="operation.progressPendingPercent"
                                  matTooltip="{{ TranslationConstants.OPERATIONS.PENDING | translate }}: {{ operation.progressPendingPercent | number: '1.1-1' }}%">
                                </div>
                                <div
                                  class="bar residual"
                                  [style.flex-basis.%]="operation.progressResidualPercent"
                                  matTooltip="{{ TranslationConstants.OPERATIONS.RESIDUAL | translate }}: {{ operation.progressResidualPercent | number: '1.1-1' }}%">
                                </div>
                              </div>
                            </div>
                            <div>
                              {{ TranslationConstants.OPERATIONS.RUNNING | translate }}:
                              {{ operation.model.progressRunning }}
                            </div>
                            <div>
                              {{ TranslationConstants.OPERATIONS.SCRAP | translate }}:
                              {{ operation.model.scrapCount }}
                            </div>
                          </div>
                          <div class="operation-header-row operation-progress">
                            <div class="multi-progress-container">
                              <div
                                class="bar success"
                                [style.flex-basis.%]="operation.progressSuccessPercent"
                      matTooltip="{{
                        TranslationConstants.OPERATIONS.SUCCESS | translate
                      }}: {{
                        operation.progressSuccessPercent | number : '1.1-1'
                      }}%"
                              ></div>
                              <div
                                class="bar scrap"
                                [style.flex-basis.%]="operation.progressScrapPercent"
                      matTooltip="{{
                        TranslationConstants.OPERATIONS.SCRAP | translate
                      }}: {{
                        operation.progressScrapPercent | number : '1.1-1'
                      }}%"
                              ></div>
                              <div
                                class="bar running"
                                [style.flex-basis.%]="operation.progressRunningPercent"
                      matTooltip="{{
                        TranslationConstants.OPERATIONS.RUNNING | translate
                      }}: {{
                        operation.progressRunningPercent | number : '1.1-1'
                      }}%"
                              ></div>
                              <div
                                class="bar pending"
                                [style.flex-basis.%]="operation.progressPendingPercent"
                      matTooltip="{{
                        TranslationConstants.OPERATIONS.PENDING | translate
                      }}: {{
                        operation.progressPendingPercent | number : '1.1-1'
                      }}%"
                              ></div>
                              <div
                                class="bar residual"
                                [style.flex-basis.%]="operation.progressResidualPercent"
                      matTooltip="{{
                        TranslationConstants.OPERATIONS.RESIDUAL | translate
                      }}: {{
                        operation.progressResidualPercent | number : '1.1-1'
                      }}%"
                              ></div>
                            </div>
                          </div>
                        </div>
                      </mat-expansion-panel-header>
                      <div class="operation-details flex-row-center">
                        <div class="operation-details-content">
                          <div>
                            {{ TranslationConstants.OPERATIONS.RECIPE | translate }}:
                            {{ operation.model.recipeName }}
                          </div>
                          <div>
                            {{
                            TranslationConstants.OPERATIONS.REPORTED_SUCCESS
                            | translate
                            }}:
                            {{ operation.model.reportedSuccessCount }}
                          </div>
                          <div>
                            {{
                            TranslationConstants.OPERATIONS.REPORTED_SCRAP | translate
                            }}:
                            {{ operation.model.reportedFailureCount }}
                          </div>
                          <div>
                            {{
                            TranslationConstants.OPERATIONS.OVERDELIVERY | translate
                            }}:
                            {{ operation.model.overDeliveryAmount }}
                          </div>
                          <div>
                            {{
                            TranslationConstants.OPERATIONS.UNDERDELIVERY | translate
                            }}:
                            {{ operation.model.underDeliveryAmount }}
                          </div>
                        </div>
                        <div
                          class="operation-details-state"
                [ngStyle]="{
                  color:
                    operation.model.classification === 'Failed'
                      ? '#e3232f'
                      : 'inherit'
                }"
                          >
                          {{ operation.model.stateDisplayName }}
                        </div>
                      </div>
                      <div class="operation-details-buttons">
                        <span
                [matTooltip]="
                  !operation.model.canAssign
                    ? (TranslationConstants.OPERATIONS.REASSIGN_NOT_POSSIBLE
                      | translate)
                    : operation.model.isCreated
                    ? (TranslationConstants.OPERATIONS.REFRESH_RECOMMENDED
                      | translate)
                    : (TranslationConstants.OPERATIONS.REFRESH_OPTIONAL
                      | translate)
                "
                          matTooltipShowDelay="300"
                          >
                          <button
                            mat-stroked-button
                            color="primary"
                            (click)="onAssign(operation)"
                            [disabled]="!operation.model.canAssign"
                  [matBadge]="
                    operation.model.canAssign && operation.model.isCreated
                      ? '!'
                      : ''
                  "
                  [matBadgeHidden]="
                    !(operation.model.canAssign && operation.model.isCreated)
                  "
                            matBadgeColor="accent"
                            >
                            <mat-icon>sync</mat-icon>
                            {{ TranslationConstants.OPERATIONS.REFRESH_DATA | translate }}
                          </button>
                        </span>
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="onShowMessages(operation)"
                          [matBadge]="operation.errorMessagesCount"
                          [matBadgeHidden]="operation.errorMessagesCount < 1"
                          matBadgeColor="warn"
                          >
                          <mat-icon>chat_alt</mat-icon>
                          {{ TranslationConstants.OPERATIONS.MESSAGES | translate }}
                        </button>
                        @if (operation.model.operationSource) {
                          <button
                            mat-stroked-button
                            color="primary"
                            (click)="onToggleSource(operation)"
                            >
                            <mat-icon>move_to_inbox</mat-icon>
                            {{ TranslationConstants.OPERATIONS.SOURCE | translate }}
                          </button>
                        }
                        @if (!operation.model.isFailed && operation.model.hasPartList) {
                          <button
                            mat-stroked-button
                            color="primary"
                            (click)="onShowPartList(operation)"
                            >
                            <mat-icon>summarize</mat-icon>
                            {{ TranslationConstants.OPERATIONS.PART_LIST | translate }}
                          </button>
                        }
                        @if (
                          !operation.model.isFailed && operation.model.hasDocuments
                          ) {
                          <button
                            mat-stroked-button
                            color="primary"
                            (click)="showDocuments(operation)"
                            >
                            <mat-icon>perm_media</mat-icon>
                            {{ TranslationConstants.OPERATIONS.DOCUMENTS | translate }}
                          </button>
                        }
                        @if (
                          !operation.model.isFailed &&
                          !operation.model.isAssigning &&
                          operation.model.recipeIds &&
                          operation.model.recipeIds.length > 0
                          ) {
                          <button
                            mat-stroked-button
                            color="primary"
                            (click)="showRecipes(operation)"
                            >
                            <mat-icon>tune</mat-icon>
                            {{ TranslationConstants.OPERATIONS.RECIPES | translate }}
                          </button>
                        }
                      </div>
                      <mat-action-row>
                        @if (operation.model.canAssign && !operation.model.isCreated) {
                          <button
                            mat-flat-button
                            color="primary"
                            (click)="onAssign(operation)"
                            >
                            {{ TranslationConstants.OPERATIONS.TRY_AGAIN | translate }}
                          </button>
                        }
                        <button
                          mat-flat-button
                          color="primary"
                          (click)="onBegin(operation)"
                          [disabled]="!operation.model.canBegin"
                          >
                          {{
                          operation.model.classification !==
                          OperationStateClassification.Running &&
                          operation.model.classification !==
                          OperationStateClassification.Interrupting
                          ? (TranslationConstants.OPERATIONS.BEGIN | translate)
                          : (TranslationConstants.OPERATIONS.CHANGE_AMOUNT
                          | translate)
                          }}
                        </button>
                        <button
                          mat-flat-button
                          color="primary"
                          (click)="onInterrupt(operation)"
                          [disabled]="!operation.model.canInterrupt"
                          >
                          {{ TranslationConstants.OPERATIONS.INTERRUPT | translate }}
                        </button>
                        <button
                          mat-flat-button
                          color="primary"
                          [disabled]="!operation.model.canReport"
                          (click)="onReport(operation)"
                          >
                          {{ TranslationConstants.OPERATIONS.REPORT | translate }}
                        </button>
                      </mat-action-row>
                    </mat-expansion-panel>
                  }
                </mat-accordion>
              </div>
            </mat-drawer-content>
          </mat-drawer-container>
        } @else {
          <empty-state
    header="{{
      TranslationConstants.OPERATIONS.EMPTY_STATE_HEADER | translate
    }}"
            message="{{ TranslationConstants.OPERATIONS.EMPTY_STATE_TEXT | translate }}"
          ></empty-state>
        }
        <button
          class="operation-create-fab-button"
          mat-mini-fab
          color="primary"
          (click)="onCreate()"
          >
          <mat-icon>add</mat-icon>
        </button>
      } @else {
        <div class="operations-loading">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>
      }


